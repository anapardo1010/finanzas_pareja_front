<div class="couple-page">
  <header class="header">
    <h1>Gestión de Pareja</h1>
    <p>Configura las aportaciones de cada integrante</p>
  </header>

  @if (loading()) {
    <div class="loader">Cargando...</div>
  } @else {
    <div class="users-grid">
      @for (user of users(); track user.id) {
        <div class="user-card">
          <div class="user-info">
            <div class="avatar">{{ user.name.charAt(0) }}</div>
            <div class="text">
              <h3>{{ user.name }}</h3>
              <p>{{ user.email }}</p>
            </div>
          </div>
          
          <div class="contribution-box">
            <span class="label">Aportación</span>
            <span class="value">{{ user.contributionPercentage || 0 }}%</span>
          </div>

          <button class="btn-edit-user" (click)="openEditForm(user)">
            <lucide-icon [img]="icons.Edit2" [size]="16"></lucide-icon>
            Editar Perfil
          </button>
        </div>
      }

      @if (users().length < 2) {
        <div class="add-partner" (click)="openInviteForm()">
          <lucide-icon [img]="icons.UserPlus" [size]="32"></lucide-icon>
          <span>Añadir Pareja</span>
        </div>
      }
    </div>

    @if (users().length === 2) {
      <div class="total-status" [class.is-error]="getTotalPercentage() !== 100">
        <lucide-icon [img]="icons.Info" [size]="20"></lucide-icon>
        <span>Suma total: <strong>{{ getTotalPercentage() }}%</strong></span>
      </div>
    }
  }
</div>

@if (showInviteForm()) {
  <div class="modal-container">
    <div class="modal-overlay" (click)="closeInviteForm()"></div>
    <div class="modal-body">
      <div class="modal-header">
        <h2>Añadir Pareja</h2>
        <button class="close-btn" (click)="closeInviteForm()">×</button>
      </div>

      <form [formGroup]="inviteForm" (ngSubmit)="onInviteSubmit()">
        <div class="modal-content">
          <div class="field">
            <label>Nombre</label>
            <input type="text" formControlName="name" placeholder="Ej. Ana García" [class.error]="inviteForm.get('name')?.invalid && inviteForm.get('name')?.touched">
            @if (inviteForm.get('name')?.invalid && inviteForm.get('name')?.touched) {
              <small class="error-msg">Nombre requerido (mín. 2 caracteres)</small>
            }
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" formControlName="email" placeholder="correo@pareja.com" [class.error]="inviteForm.get('email')?.invalid && inviteForm.get('email')?.touched">
            @if (inviteForm.get('email')?.invalid && inviteForm.get('email')?.touched) {
              <small class="error-msg">Email válido requerido</small>
            }
          </div>
          <div class="field">
            <label>Contraseña Temporal</label>
            <input type="password" formControlName="password" [class.error]="inviteForm.get('password')?.invalid && inviteForm.get('password')?.touched">
            @if (inviteForm.get('password')?.invalid && inviteForm.get('password')?.touched) {
              <small class="error-msg">Contraseña requerida (mín. 6 caracteres)</small>
            }
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeInviteForm()">Cancelar</button>
          <button type="submit" class="btn-save" [disabled]="inviteForm.invalid">Invitar</button>
        </div>
      </form>
    </div>
  </div>
}

@if (showEditForm()) {
  <div class="modal-container">
    <div class="modal-overlay" (click)="closeEditForm()"></div>
    <div class="modal-body">
      <div class="modal-header">
        <h2>Editar Integrante</h2>
        <button class="close-btn" (click)="closeEditForm()">×</button>
      </div>

      <form [formGroup]="editForm" (ngSubmit)="onEditSubmit()">
        <div class="modal-content">
          <div class="field">
            <label>Nombre</label>
            <input type="text" formControlName="name">
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" formControlName="email" readonly>
          </div>
          <div class="field">
            <label>Porcentaje de Aportación (%)</label>
            <input type="number" formControlName="contributionPercentage">
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeEditForm()">Cancelar</button>
          <button type="submit" class="btn-save" [disabled]="editForm.invalid">Guardar</button>
        </div>
      </form>
    </div>
  </div>
}