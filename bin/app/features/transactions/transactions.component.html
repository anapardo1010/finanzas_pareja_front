<div class="transactions-page">
  <header class="page-header">
    <div class="header-left">
      <h1 class="page-title">Historial de Transacciones</h1>
      <p class="page-subtitle">Gestiona y supervisa tus movimientos financieros</p>
    </div>

    <div class="summary-cards">
      <div class="summary-card income">
        <div class="card-icon">‚Üë</div>
        <div class="card-info">
          <span class="label">INGRESOS</span>
          <span class="amount">{{ totalIncomes() | currency:'MXN':'symbol':'1.2-2' }}</span>
        </div>
      </div>
      <div class="summary-card expense">
        <div class="card-icon">‚Üì</div>
        <div class="card-info">
          <span class="label">GASTOS</span>
          <span class="amount">{{ totalExpenses() | currency:'MXN':'symbol':'1.2-2' }}</span>
        </div>
      </div>
      <div class="summary-card balance" [class.negative]="balance() < 0">
        <div class="card-icon">‚áÑ</div>
        <div class="card-info">
          <span class="label">NETO</span>
          <span class="amount">{{ balance() | currency:'MXN':'symbol':'1.2-2' }}</span>
        </div>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <div class="filters-bar">
      <div class="filter-group">
        <label for="filterStartDate">Desde</label>
        <input id="filterStartDate" type="date" [value]="filterStartDate()" (change)="filterStartDate.set($any($event.target).value); applyDateFilter()" class="filter-input">
      </div>
      <div class="filter-group">
        <label for="filterEndDate">Hasta</label>
        <input id="filterEndDate" type="date" [value]="filterEndDate()" (change)="filterEndDate.set($any($event.target).value); applyDateFilter()" class="filter-input">
      </div>
      <div class="filter-group">
        <label for="filterUserId">Persona</label>
        <select id="filterUserId" [value]="filterUserId() ?? ''" (change)="filterUserId.set($any($event.target).value ? +$any($event.target).value : null)" class="filter-select">
          <option value="">Todas las personas</option>
          @for (user of availableUsers; track user.id) {
            <option [value]="user.id">{{ user.name }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label for="filterPaymentMethodId">Tarjeta/Cuenta</label>
        <select id="filterPaymentMethodId" [value]="filterPaymentMethodId() ?? ''" (change)="filterPaymentMethodId.set($any($event.target).value ? +$any($event.target).value : null)" class="filter-select">
          <option value="">Todas las tarjetas/cuentas</option>
          @for (pm of paymentMethods(); track pm.id) {
            <option [value]="pm.id">{{ pm.alias || pm.bankName }}</option>
          }
        </select>
      </div>
    </div>
    <div class="action-buttons">
      <button class="btn-action expense" (click)="openCreateForm('EXPENSE')" title="Registra un gasto que s√≠ descuenta de tu saldo total.">+ Registrar Gasto</button>
      <button class="btn-action income" (click)="openCreateForm('INCOME')" title="Registra un ingreso que suma a tu saldo total.">+ Ingreso</button>
      <button class="btn-action credit" (click)="openCreateForm('CREDIT_PAYMENT')" title="Registra pagos a tu tarjeta, no afecta el saldo total.">Pago de Tarjeta (no descuenta saldo)</button>
      <button class="btn-action transfer" (click)="openCreateForm('TRANSFER')" title="Transfiere entre tus cuentas, el dinero sigue disponible.">Transferencia Interna (no descuenta saldo)</button>
    </div>
  </div>

  <div class="transactions-list">
    @for (t of filteredTransactions(); track t.id) {
      <div class="transaction-item {{ t.transactionType.toLowerCase() }}" (click)="editTransaction(t)">
        <div class="item-left {{ t.transactionType.toLowerCase() }}">
          <div class="type-indicator {{ t.transactionType.toLowerCase() }}">
            <span class="icon">{{ t.transactionType === 'INCOME' ? '‚Üë' : t.transactionType === 'EXPENSE' ? '‚Üì' : t.transactionType === 'CREDIT_PAYMENT' ? 'üí≥' : '‚áÑ' }}</span>
          </div>
          <div class="item-details {{ t.transactionType.toLowerCase() }}">
            <span class="description {{ t.transactionType.toLowerCase() }}">{{ t.description }}</span>
            <div class="meta {{ t.transactionType.toLowerCase() }}">
              <span class="category {{ t.transactionType.toLowerCase() }}">üè∑Ô∏è {{ getCategoryName(t.categoryId) }}</span>
              <span class="divider">/</span>
              <span class="date {{ t.transactionType.toLowerCase() }}">{{ t.date | date:'MMM d, y' }}</span>
              <span class="divider">/</span>
              <span class="account {{ t.transactionType.toLowerCase() }}">üí≥ {{ getPaymentMethodName(t.paymentMethodId) }}</span>
            </div>
          </div>
        </div>

        <div class="item-right {{ t.transactionType.toLowerCase() }}">
          <div class="amount-container {{ t.transactionType.toLowerCase() }}">
            <span class="amount-value {{ t.transactionType.toLowerCase() }}">
              {{ t.transactionType === 'INCOME' ? '' : '-' }}{{ t.amount | currency:'MXN':'symbol-narrow':'1.2-2' }}
            </span>
            @if (t.isShared) {
              <span class="badge-shared {{ t.transactionType.toLowerCase() }}">COMPARTIDO</span>
            }
            @if (t.hasInstallments) {
              <span class="badge-shared {{ t.transactionType.toLowerCase() }}">MSI</span>
            }
          </div>
          <button class="btn-more {{ t.transactionType.toLowerCase() }}" (click)="$event.stopPropagation(); deleteTransaction(t)" title="Eliminar">
            <lucide-icon [img]="icons.X" [size]="18"></lucide-icon>
          </button>
        </div>
      </div>
    }
  </div>

  @if (showForm()) {
    <app-transaction-form
      [form]="transactionForm"
      [type]="selectedTransactionType()"
      [transaction]="selectedTransaction()"
      [categories]="categories()"
      [paymentMethods]="paymentMethods()"
      [users]="users()"
      [submitting]="submitting()"
      (submit)="onSubmit()"
      (close)="closeForm()">
    </app-transaction-form>
  }
</div>