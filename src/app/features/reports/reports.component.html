<div class="reports-page">
  <div class="page-header">
    <h1 class="page-title">Reportes</h1>
  </div>

  <nav class="reports-submenu">
    <button [class.active]="activeTab === 'cards'" (click)="activeTabWithLoad = 'cards'">Saldos de Tarjetas</button>
    <button [class.active]="activeTab === 'debit'" (click)="activeTabWithLoad = 'debit'">Débito y Efectivo</button>
    <button [class.active]="activeTab === 'msi'" (click)="activeTabWithLoad = 'msi'">MSI</button>
  </nav>

  <ng-container *ngIf="activeTab === 'debit'">
    <div class="tab-header">
      <div class="title-group">
        <h2 class="tab-title">Débito y Efectivo</h2>
        <p class="subtitle">Saldos disponibles y reparto proporcional por usuario</p>
      </div>
      <!-- Refresh removed: date range auto-applies -->
    </div>

    <div class="filters-container transactions-style">
      <div class="filter-group">
        <label for="debitStart">Desde</label>
        <input id="debitStart" type="date" [(ngModel)]="filterStartDate" (change)="loadDebitBalances()" class="filter-input" />
      </div>
      <div class="filter-group">
        <label for="debitEnd">Hasta</label>
        <input id="debitEnd" type="date" [(ngModel)]="filterEndDate" (change)="loadDebitBalances()" class="filter-input" />
      </div>
    </div>

    @if (loading()) {
      <div class="loading-state"><div class="spinner"></div></div>
    } @else {
      <div class="debit-grid">
        @for (balance of getDebitDebts(); track balance.paymentMethodId) {
          <div class="debit-card" [class.is-cash]="balance.accountType === 'CASH'">
            <div class="debit-card-header">
              <div class="icon-circle">
                <lucide-icon [img]="balance.accountType === 'CASH' ? icons.DollarSign : icons.Wallet" [size]="20"></lucide-icon>
              </div>
              <span class="account-type-tag">{{ balance.accountType }}</span>
            </div>
            
            <div class="debit-card-body">
              <h3 class="account-name">{{ balance.alias || balance.paymentMethodName || 'Efectivo' }}</h3>
              <p class="account-alias">{{ balance.paymentMethodName || '' }}</p>
              <div class="balance-display">
                <div class="balance-amount">
                  <span class="currency-symbol">$</span>
                  <span class="amount-value">{{ (balance.balance ?? balance.currentBalance ?? 0) | number:'1.0-0' }}</span>
                </div>
              </div>

              <div class="user-shares-compact">
                <div class="shares-title">Reparto por usuario · {{ balance.transactionCount }} trans.</div>
                @for (share of getDebtors(balance); track share.userId) {
                  <div class="share-row">
                    <div class="share-left">
                      <div class="user-avatar-small">{{ share.userName.charAt(0) }}</div>
                      <div class="share-user">{{ share.userName }}</div>
                    </div>
                    <div class="share-right">
                      <div class="share-label">A pagar</div>
                      <div class="share-amount">{{ formatCurrency(share.amountToPay) }}</div>
                    </div>
                  </div>
                } @if (getDebtors(balance).length === 0) {
                  <div class="no-debtors">Nadie debe en este periodo</div>
                }
              </div>
            </div>

            <div class="debit-card-footer">
              <div class="user-info">
                <div class="user-avatar">{{ (balance.alias || balance.paymentMethodName || 'E').charAt(0) }}</div>
                <div>
                  <div class="user-name">Titular: <strong>{{ getOwnerName(balance) }}</strong> · {{ balance.transactionCount }} trans.</div>
                  @if (getDebtors(balance).length > 0) {
                    <div class="owner-summary">De estas transacciones, <strong>{{ getDebtors(balance).length }}</strong> debe(n) <strong>{{ formatCurrency(getTotalOwed(balance)) }}</strong></div>
                  } @else {
                    <div class="owner-summary">No hay deudores en este periodo</div>
                  }
                </div>
              </div>
            </div>
          </div>
        } @empty {
          <div class="msi-empty">No se encontraron cuentas de débito o efectivo.</div>
        }
      </div>
    }
  </ng-container>

  <ng-container *ngIf="activeTab === 'cards'">
    <div class="page-header">
      <h2 class="page-title">Saldos de Tarjetas</h2>
      <button class="btn-refresh" (click)="loadCards()" [disabled]="loading()">
        <lucide-icon [img]="icons.CreditCard" [size]="18"></lucide-icon>
        Actualizar
      </button>
    </div>

    @if (loading()) {
      <div class="loading-state"><div class="spinner"></div></div>
    } @else {
      @if (finalSettlement(); as s) {
        <div class="settlement-summary-card">
          <h4 class="summary-title">
            <lucide-icon [img]="icons.BarChart3" [size]="20"></lucide-icon>
            Resumen de Liquidación
          </h4>
          <div class="settlement-breakdown">
            <div class="breakdown-row">
              <span class="label">Me deben (mis tarjetas):</span>
              <span class="amount positive">{{ formatCurrency(s.owedToMe) }}</span>
            </div>
            <div class="breakdown-row">
              <span class="label">Debo (tarjetas de {{ s.partnerName }}):</span>
              <span class="amount negative">{{ formatCurrency(s.iOwe) }}</span>
            </div>
          </div>
          <div class="final-settlement">
            <div class="settlement-result">
              <span class="settlement-text">{{ s.message }}</span>
              <span class="settlement-amount">{{ formatCurrency(s.netDifference) }}</span>
            </div>
          </div>
        </div>
      }

      <div class="cards-balances-grid">
        @for (card of cards(); track card.paymentMethodId) {
          <div class="card-balance-item" 
               [class.selected]="card.selected" 
               [class]="'status-' + getStatusClass(card.paymentStatus)"
               (click)="toggleSelection(card)">
            <div class="card-header">
              <div class="title-group">
                <h3 class="bank-name">{{ card.bankName }}</h3>
                <span class="alias">{{ card.alias }}</span>
              </div>
              <span class="status-badge" [class]="getStatusClass(card.paymentStatus)">
                {{ card.paymentStatus }}
              </span>
            </div>
            <div class="card-balance-details">
              <div class="balance-row total-due">
                <span class="label">Total a pagar:</span>
                <span class="value">{{ formatCurrency(card.totalDue) }}</span>
              </div>
              <div class="balance-row">
                <span class="label">Gastos mes:</span>
                <span class="value">{{ formatCurrency(card.currentBalance) }}</span>
              </div>
            </div>
            <div class="user-shares-compact">
              @for (share of card.userShares; track share.userId) {
                <div class="share-row">
                  <span class="share-user">{{ share.userName }}</span>
                  <span class="share-amount">{{ formatCurrency(share.amountToPay) }}</span>
                </div>
              }
            </div>
            <div class="card-dates">
              <div class="date-item">
                <lucide-icon [img]="icons.Calendar" [size]="14"></lucide-icon>
                <span>Corte: <strong>{{ formatDate(card.cutDate) }}</strong></span>
              </div>
              <div class="date-item">
                <lucide-icon [img]="icons.DollarSign" [size]="14"></lucide-icon>
                <span>Pago: <strong>{{ formatDate(card.paymentDate) }}</strong></span>
              </div>
            </div>
            @if (card.paymentStatus !== 'PAID') {
              <div class="card-actions">
                <button class="btn-mark-paid" (click)="markAsPaid(card, $event)">
                  <lucide-icon [img]="icons.CreditCard" [size]="16"></lucide-icon>
                  Marcar como Pagado
                </button>
              </div>
            }
          </div>
        }
      </div>
    }
  </ng-container>

  <ng-container *ngIf="activeTab === 'msi'">
  <div class="page-header">
    <div class="title-group">
      <h2 class="page-title">Meses Sin Intereses</h2>
      <p class="subtitle">Proyección de pagos para los próximos meses</p>
    </div>
    <div class="header-actions">
      <select class="select-months" (change)="onMonthsChange($event)">
        <option value="3">Próximos 3 meses</option>
        <option value="6">Próximos 6 meses</option>
        <option value="12">1 año</option>
      </select>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-state"><div class="spinner"></div></div>
  } @else {
    <div class="msi-summary-grid">
      <div class="summary-box">
        <span class="label">Total a pagar este mes</span>
        <span class="value">{{ formatCurrency(totalMsiThisMonth()) }}</span>
      </div>
      <div class="summary-box">
        <span class="label">Cuotas pendientes</span>
        <span class="value">{{ msiInstallments().length }}</span>
      </div>
    </div>

    <div class="msi-timeline">
      @for (monthGroup of groupedMsi(); track monthGroup.monthName) {
        <div class="msi-month-group">
          <div class="month-divider">
            <span class="month-name">{{ monthGroup.monthName }}</span>
            <span class="month-total">{{ formatCurrency(monthGroup.total) }}</span>
          </div>

          <div class="msi-list">
            @for (item of monthGroup.installments; track item.installmentId) {
              <div class="msi-card">
                <div class="msi-main-info">
                  <div class="msi-desc">
                    <span class="description">{{ item.transactionDescription }}</span>
                    <span class="bank-tag">{{ item.paymentMethodName }}</span>
                  </div>
                  <div class="msi-badge">
                    {{ item.installmentNumber }}/{{ item.totalInstallments }}
                  </div>
                </div>
                <div class="msi-amount-info">
                  <span class="amount">{{ formatCurrency(item.installmentAmount) }}</span>
                  <span class="date">{{ formatDate(item.projectedDate) }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      } @empty {
        <div class="msi-empty">No tienes cuotas MSI programadas para este periodo.</div>
      }
    </div>
  }
</ng-container>
</div>